name: Deploy to Azure Container Apps

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'docker/**'
      - '.github/workflows/azure-deploy.yml'

env:
  AZURE_CONTAINER_REGISTRY: ndtchatbotacr.azurecr.io
  ACR_NAME: ndtchatbotacr
  BACKEND_IMAGE: ndtchatbotacr.azurecr.io/ndt-backend
  FRONTEND_IMAGE: ndtchatbotacr.azurecr.io/ndt-frontend
  RESOURCE_GROUP: Neil-deGrasse-Tyson-Chatbot-RG
  BACKEND_APP_NAME: ndt-backend
  FRONTEND_APP_NAME: ndt-frontend
  LOCATION: westus

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure resource group and environment
        run: |
          az group create --name "${{ env.RESOURCE_GROUP }}" --location "${{ env.LOCATION }}" || true
          az containerapp env create \
            --name ndt-env \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --location "${{ env.LOCATION }}" || true

      - name: Wait for backend image in ACR
        run: |
          TAG="${{ github.sha }}"
          REPO="ndt-backend"
          for i in {1..40}; do
            COUNT=$(az acr repository show-tags -n "${{ env.ACR_NAME }}" --repository "$REPO" --query "[?@=='$TAG'] | length(@)" -o tsv || echo 0)
            if [ "$COUNT" = "1" ]; then
              echo "Found image $REPO:$TAG"
              exit 0
            fi
            echo "Waiting for $REPO:$TAG in ACR ($i/40)..."
            sleep 15
          done
          echo "Image $REPO:$TAG not found in ACR" >&2
          exit 1

      - name: Get ACR credentials
        run: |
          ADMIN_ENABLED=$(az acr show -n "${{ env.ACR_NAME }}" --query "adminUserEnabled" -o tsv)
          if [ "$ADMIN_ENABLED" != "true" ]; then
            az acr update -n "${{ env.ACR_NAME }}" --admin-enabled true
          fi
          echo "ACR_USERNAME=$(az acr credential show -n \"${{ env.ACR_NAME }}\" --query \"username\" -o tsv)" >> "$GITHUB_ENV"
          echo "ACR_PASSWORD=$(az acr credential show -n \"${{ env.ACR_NAME }}\" --query \"passwords[0].value\" -o tsv)" >> "$GITHUB_ENV"

      - name: Deploy Backend
        id: deploy_backend
        run: |
          set -e
          az containerapp create \
            --name "${{ env.BACKEND_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --environment ndt-env \
            --image "${{ env.BACKEND_IMAGE }}:${{ github.sha }}" \
            --target-port 8000 \
            --ingress external \
            --registry-server "${{ env.AZURE_CONTAINER_REGISTRY }}" \
            --registry-username "$ACR_USERNAME" \
            --registry-password "$ACR_PASSWORD" \
            --env-vars OPENAI_API_KEY=secretref:openai-api-key \
            --env-vars ANTHROPIC_API_KEY=secretref:anthropic-api-key \
            --cpu 1.0 --memory 2.0Gi \
            --min-replicas 1 --max-replicas 3 \
            --secrets openai-api-key="${{ secrets.OPENAI_API_KEY }}" \
            --secrets anthropic-api-key="${{ secrets.ANTHROPIC_API_KEY }}" \
            --query properties.configuration.ingress.fqdn --output tsv || \
          ( az containerapp registry set \
              --name "${{ env.BACKEND_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --server "${{ env.AZURE_CONTAINER_REGISTRY }}" \
              --username "$ACR_USERNAME" \
              --password "$ACR_PASSWORD" \
            && az containerapp update \
              --name "${{ env.BACKEND_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --image "${{ env.BACKEND_IMAGE }}:${{ github.sha }}" )

      - name: Get Backend URL
        id: backend_url
        run: |
          BACKEND_URL=$(az containerapp show \
            --name "${{ env.BACKEND_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "url=https://$BACKEND_URL" >> "$GITHUB_OUTPUT"

    outputs:
      backend-url: ${{ steps.backend_url.outputs.url }}
