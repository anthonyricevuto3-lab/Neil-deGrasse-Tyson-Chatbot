name: Deploy to Existing Azure Resources

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy-existing-resources.yml'

env:
  RESOURCE_GROUP: neil-degrasse-tyson-chatbot-rg
  BACKEND_CONTAINER_NAME: ndt-backend-api
  STATIC_WEB_APP_NAME: neil-degrasse-tyson-chatbot-wa
  BACKEND_IMAGE: ghcr.io/anthonyricevuto3-lab/neil-degrasse-tyson-chatbot/backend:main
  AZURE_LOCATION: westus

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy Backend to Azure Container Instances
      run: |
        echo "Deploying backend container..."
        
        # Delete existing container if in transitioning state
        az container delete \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_CONTAINER_NAME }} \
          --yes \
          || echo "No existing container to delete"
        
        # Wait a moment for cleanup
        sleep 10
        
        # Create new container
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_CONTAINER_NAME }} \
          --image ${{ env.BACKEND_IMAGE }} \
          --os-type Linux \
          --registry-login-server ghcr.io \
          --registry-username ${{ github.actor }} \
          --registry-password ${{ secrets.GITHUB_TOKEN }} \
          --cpu 1 \
          --memory 1.5 \
          --ports 8000 \
          --dns-name-label ${{ env.BACKEND_CONTAINER_NAME }} \
          --environment-variables \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
          --restart-policy Always \
          --location ${{ env.AZURE_LOCATION }}
    
    - name: Get Backend URL
      id: backend-url
      run: |
        BACKEND_FQDN=$(az container show \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_CONTAINER_NAME }} \
          --query ipAddress.fqdn \
          --output tsv)
        echo "url=http://$BACKEND_FQDN:8000" >> $GITHUB_OUTPUT
        echo "âœ… Backend deployed to: http://$BACKEND_FQDN:8000"
    
    outputs:
      backend-url: ${{ steps.backend-url.outputs.url }}

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Build Frontend
      working-directory: ./frontend
      env:
        VITE_API_URL: ${{ needs.deploy-backend.outputs.backend-url }}
      run: |
        npm ci
        npm run build
    
    # Removed duplicate Static Web App deployment to avoid conflicts. Use only the main azure-static-web-apps.yml for SWA deployment.
    
    - name: Get Frontend URL
      run: |
        echo "ðŸš€ Frontend deployed to Static Web App: ${{ env.STATIC_WEB_APP_NAME }}"
        echo "ðŸ”— Backend API: ${{ needs.deploy-backend.outputs.backend-url }}"
